wget()
    mkdir -p $(dirname $OUTPUT0)
    wget --output-document="$OUTPUT0" "$URL"

wget_unzip()
    mkdir -p $(dirname $OUTPUT0)
    wget --output-document="$OUTPUT0" "$URL"
    unzip -o "$OUTPUT0" -d $(dirname $OUTPUT1)

psql()
    psql -v ON_ERROR_STOP=1 -f $INPUT && mkdir -p $(dirname $OUTPUT) && touch $OUTPUT

import_shapefile()
    BASENAME=$(echo $INPUT | sed 's/.shp//')
    # get table name from output, e.g. change $BASE/psql/input/wards gives input.wards
    TABLENAME=$(echo $OUTPUT | sed 's/.*psql\///;s/\//./')
    # -q suppresses query output which for large shapefiles seems to slow down the import
    shp2pgsql -D -I -s 4326 $INPUT $TABLENAME | psql -q && touch $OUTPUT

%include default_profile

URL="https://data.cityofchicago.org/api/geospatial/6imu-meau?method=export&format=Shapefile"
download/streets.zip, download/geo_export_ecdacebe-e3d0-4152-96e9-6559a5639038.shp <- [method:wget_unzip -timecheck]
psql/streets <- download/geo_export_ecdacebe-e3d0-4152-96e9-6559a5639038.shp [method:import_shapefile]

URL="https://s3.amazonaws.com/metro-extracts.mapzen.com/chicago_illinois.osm.pbf"
download/chicago_illinois.osm.pbf <- [method:wget -timecheck]

psql/planet_osm <- download/chicago_illinois.osm.pbf
    osm2pgsql -s 4326 --create --database $PGDATABASE $INPUT && touch $OUTPUT

URL="https://data.cityofchicago.org/api/geospatial/ewy2-6yfk?method=export&format=Shapefile"
download/city.zip, download/geo_export_b921358d-b550-4c64-a8d5-a5e11eb782c4.shp <- [method:wget_unzip -timecheck]
psql/city <- download/geo_export_b921358d-b550-4c64-a8d5-a5e11eb782c4.shp [method:import_shapefile]

psql/rast <- rast.sql, psql/city [method:psql]
psql/grid <- grid.sql, psql/city [method:psql]

psql/distances <- distances.py, psql/streets, psql/grid
    python $INPUT && touch $OUTPUT

rast_distances.tiff <- psql/rast_distances
    psql -c "\COPY (SELECT encode(ST_AsTIFF(st_setvalues), 'hex') AS tiff FROM rast_distances) TO '$OUTPUT'"
    xxd -p -r $OUTPUT > $OUTPUT
    
;psql/streets_buffered <- streets_buffered.sql, psql/streets [method:psql]
