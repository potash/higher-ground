PROFILE:=default_profile
%include $[PROFILE]

PYTHONUNBUFFERED=Y
wget()
    mkdir -p $(dirname $OUTPUT0)
    wget --output-document="$OUTPUT0" "$URL"

wget_unzip()
    mkdir -p $(dirname $OUTPUT0)
    wget --output-document="$OUTPUT0" "$URL"
    unzip -o "$OUTPUT0" -d $(dirname $OUTPUT1)

psql()
    cat $INPUT | envsubst | psql -v ON_ERROR_STOP=1 2>&1 && echo > $OUTPUT

raster2tiff()
    TABLE=$(basename $INPUT)
    psql -c "\COPY (SELECT encode(ST_AsTIFF(rast), 'hex') AS tiff FROM $TABLE) TO STDOUT" | xxd -p -r > $OUTPUT
    
psql/planet_osm <- download/chicago_illinois.osm.pbf
    osm2pgsql --slim --proj $SRID --create --database $PGDATABASE $INPUT && touch $OUTPUT

psql/land <- land.sql, psql/planet_osm [method:psql]
; grid of pixels
psql/extent <- extent.sql, psql/planet_osm, psql/land [method:psql]
psql/roads <- roads.sql, psql/planet_osm [method:psql]

; grid of pixels
psql/grid <- grid.sql, psql/extent, psql/land [method:psql]

; calculate distance and update grid.distance
psql/distances <- distances.py, psql/planet_osm, psql/grid, psql/roads
    python $INPUT && touch $OUTPUT

; create empty raster band
psql/rast <- rast.sql, psql/extent [method:psql]
; create new raster setting pixels of rast with distances
psql/rast_distances <- rast_distances.sql, psql/distances, psql/rast [method:psql]

; https://petewarden.com/2013/08/31/how-to-save-an-image-to-disk-from-postgis/
rast_distances.tiff <- psql/rast_distances [method:raster2tiff]
    
; psql/streets_buffered <- streets_buffered.sql, psql/streets [method:psql]
